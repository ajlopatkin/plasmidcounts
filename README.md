# Plasmid Count Analysis

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![Python Version](https://img.shields.io/badge/python-3.8+-blue.svg)

This repository serves as the supplementary code base for the research paper titled: **Plasmid prevalence is independent of antibiotic resistance in environmental Enterobacteriaceae**, authored by: **Danya Gewurz (dgewurz@gmail.com), Abhishek Sharma (ashar58@ur.rochester.edu), Joanna Harrison (joannacharrison@comcast.net), Ivan Lee (ilee24@u.rochester.edu), Suhyeon Kim (skim328@ur.rochester.edu), Nicole Rondeau (nicole.rondeau@nyulangone.org), JJ Miranda (jmiranda@barnard.edu), Brian Mailloux (bmailloux@barnard.edu), Kerry Hamilton (kerry.hamilton@asu.edu), Allison J. Lopaltin (allison.lopatkin@rochester.edu)**. The provided scripts and environment configurations allow users to replicate the plasmid count analysis performed in our study.

## Table of Contents

- [Project Overview](#project-overview)
- [Repository Structure](#repository-structure)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Usage](#usage)
  - [main.py](#mainpy)
  - [sensitivity_analysis.py](#sensitivity_analysispy)
- [Parameters Explained](#parameters-explained)
- [Output Files](#output-files)
- [Dataset](#dataset)
- [Contributing](#contributing)
- [License](#license)
- [Contact](#contact)

## Project Overview

This project involves the analysis of plasmid counts within genomic data. The provided scripts automate the process of running PlasmidFinder, performing sensitivity analyses by varying specific parameters, and aggregating the results for downstream analysis and manuscript preparation.

## Repository Structure
├── main.py \
├── sensitivity_analysis.py \
├── plasmidCount_env.yml \
├── Result \
│ ├── plasmidcount_aggregated.csv \
│ ├── plasmidcount_results.csv \
│ └── Plasmidfinder_results.csv \
├── README.md \
└── LICENSE 

- **main.py**: The primary script to execute the plasmid count analysis.
- **sensitivity_analysis.py**: Executes the analysis across various parameter sets to assess sensitivity.
- **plasmidCount_env.yml**: Conda environment file containing all dependencies required to run the scripts.
- **Result**: Directory containing the output CSV files generated by `main.py`.
- **README.md**: This documentation file.
- **LICENSE**: Licensing information for the repository.

## Prerequisites

- **Operating System**: Windows, macOS, or Linux
- **Python**: Version 3.8 or higher
- **Conda**: Anaconda or Miniconda installed

## Installation

1. **Clone the Repository**

   ```bash
   git clone https://github.com/ajlopatkin/plasmidcounts
   cd plasmidcounts
   ```


2. **Create the Conda Environment**

   Ensure you have Conda installed. Then, create the environment using the provided YAML file:

   ```bash
   conda env create -f plasmidCount_env.yml
   ```

3. **Activate the Environment**

   ```bash
   conda activate plasmidCount_env
   ```

## Usage

### main.py

**Description**: The primary script to perform plasmid count analysis. It processes genomic data to identify and count plasmids, producing aggregated results.

**Outputs**:

- `plasmidcount_aggregated.csv`: Contains filenames and corresponding plasmid counts.
- `plasmidcount_results.csv`: Detailed results including filename, file type, contig information, plasmid details, and top hits.
- `Plasmidfinder_results.csv`: Results from running PlasmidFinder on the input data.

Before running the application, please extract the data zip file and update the following configuration variables to point to the corresponding folders within the extracted contents:

- **basedir**: Set to the path of the `basedir` folder.
- **db_path**: Set to the path of the `db` folder.
  
**Instructions**:

1. **Configure Parameters**:

   Open `main.py` and specify the following paths:

   ```python
   basedir = "/path/to/your/data"
   db_path = "/path/to/db"
   output_dir = "/path/to/save/results"
   ```

2. **Run the Script**:

   ```bash
   python main.py
   ```

### sensitivity_analysis.py

**Description**: Similar to `main.py`, this script performs plasmid count analysis across various parameter values to conduct sensitivity analysis. Each parameter is varied one at a time from its base value while keeping others constant. Please update the path parameters in this script similar to what was done before running `main.py` file.

**Example Usage**:

Suppose the base parameters are:

- `contig_len_cutoff`: 500
- `mash_cutoff`: 0.05
- `plasfinder_pid`: 90
- `plasfinder_cov`: 80
- `blast_len_thresh`: 27000
- `overlap_cutoff_short`: 0.01
- `overlap_cutoff_long`: 0.15
- `blast_len_cutoff`: 1000
- `filter_col`: True

The script will generate 41 different runs, each varying one parameter at a time from the following lists:

- **`contig_len_cutoff`**: [300, 800, 1300, 1800, 2000]
- **`mash_cutoff`**: [0.01, 0.03, 0.05, 0.07, 0.1]
- **`plasfinder_pid`**: [60, 70, 80, 90, 100]
- **`plasfinder_cov`**: [60, 70, 80, 90, 100]
- **`blast_len_thresh`**: [20000, 30000, 40000, 50000]
- **`overlap_cutoff_short`**: [0, 0.1, 0.2, 0.3, 0.5]
- **`overlap_cutoff_long`**: [0, 0.1, 0.2, 0.3, 0.5]
- **`blast_len_cutoff`**: [0, 10000, 20000, 30000, 50000]
- **`filter_col`**: [False]

**Instructions**:

1. **Configure Parameters**:

   Open `sensitivity_analysis.py` and specify the necessary paths similar to `main.py`.

2. **Run the Script**:

   ```bash
   python sensitivity_analysis.py
   ```

Each run will generate a separate output folder named following the pattern:
```bash
output_contig{contig_len_cutoff}_mash{mash_cutoff}_pid{plasfinder_pid}_cov{plasfinder_cov}_len{blast_len_thresh}_short{overlap_cutoff_short}_long{overlap_cutoff_long}_cut{blast_len_cutoff}_filterCol{filter_col}
```


For example:
```bash
output_contig500_mash0.05_pid90_cov80_len27000_short0.01_long0.15_cut1000_filterColTrue
```



## Parameters Explained

All scripts require the user to specify several key parameters. Below is a detailed explanation of each:

- **`contig_len_cutoff`** (`int`): Minimum length for contigs to retain in the analysis.

  ```python
  contig_len_cutoff = int(params['contig_len_cutoff'])  # Example: 500
  ```

- **`mash_cutoff`** (`float`): Mash distance threshold to consider two contigs as duplicates.

  ```python
  mash_cutoff = float(params['mash_cutoff'])  # Example: 0.05
  ```

- **`plasfinder_cov`** (`int`): Coverage threshold for PlasmidFinder results.

  ```python
  plasfinder_cov = int(params['plasfinder_cov'])  # Example: 80
  ```

- **`plasfinder_pid`** (`int`): Percent identity threshold for PlasmidFinder results.

  ```python
  plasfinder_pid = int(params['plasfinder_pid'])  # Example: 90
  ```

- **`blast_len_thresh`** (`int`): Threshold for contig length to perform BLAST analysis.

  ```python
  blast_len_thresh = int(params['blast_len_thresh'])  # Example: 27000
  ```

- **`overlap_cutoff_short`** (`float`): Overlap cutoff for BLAST results in short contigs.

  ```python
  overlap_cutoff_short = float(params['overlap_cutoff_short'])  # Example: 0.01
  ```

- **`overlap_cutoff_long`** (`float`): Overlap cutoff for BLAST results in long contigs.

  ```python
  overlap_cutoff_long = float(params['overlap_cutoff_long'])  # Example: 0.15
  ```

- **`blast_len_cutoff`** (`int`): Cutoff for plasmid length in PLSdb BLAST analysis.

  ```python
  blast_len_cutoff = int(params['blast_len_cutoff'])  # Example: 1000
  ```

- **`filter_col`** (`bool`): Flag to filter out Col plasmids.

  ```python
  filter_col = params['filter_col'] == "True"  # Example: True
  ```

- **`filter_std`** (`bool`): Flag to filter high-variance strains based on standard deviations. Set to `0` to disable.

  ```python
  filter_std = True  # Example: True
  ```

- **`num_contig_thresh`** (`int`): Minimum number of contigs required to apply high-variance strain filtering.

  ```python
  num_contig_thresh = 3  # Example: 3
  ```

### Example

To illustrate parameter variation, consider the following base parameters:
```bash
base_params = {
    "contig_len_cutoff": 500,
    "mash_cutoff": 0.05,
    "plasfinder_pid": 90,
    "plasfinder_cov": 80,
    "blast_len_thresh": 27000,
    "overlap_cutoff_short": 0.01,
    "overlap_cutoff_long": 0.15,
    "blast_len_cutoff": 1000,
    "filter_col": True
}
```


When running `sensitivity_analysis.py`, each parameter is varied one at a time from predefined lists while keeping the others at their base values. For instance, one run might set `contig_len_cutoff` to `300` while keeping all other parameters unchanged, enabling the assessment of how this specific variation impacts the analysis results.

## Output Files

Upon successful execution of the scripts, the following output files are generated:

1. **plasmidcount_aggregated.csv**

   - **Description**: Contains filenames and their corresponding plasmid counts.
   - **Columns**:
     - `filename`: Name of the input file.
     - `counts`: Number of plasmids identified.

2. **plasmidcount_results.csv**

   - **Description**: Detailed results of plasmid identification.
   - **Columns**:
     - `filename`: Name of the input file.
     - `file_type`: Type of the file (`short` or `long`).
     - `contig`: Identifier of the contig.
     - `contig_len`: Length of the contig.
     - `plasmid`: Name of the identified plasmid.
     - `plasmid_accession`: Accession ID of the plasmid.
     - `top_hit`: Top BLAST hit for the plasmid.

3. **Plasmidfinder_results.csv**

   - **Description**: Raw results obtained from running PlasmidFinder on the input data.
   - **Columns**:
     - Detailed plasmid identification results per contig.

## Dataset

You can download the dataset required for this analysis from the following link: [Download Dataset Here](https://rochester.box.com/s/vf26am6pdqmu5h35881q42xp857u5ze9)

## Contributing

Contributions are welcome! Please follow these guidelines:

1. **Fork the Repository**

2. **Create a Feature Branch**

   ```bash
   git checkout -b feature/YourFeature
   ```

3. **Commit Your Changes**

   ```bash
   git commit -m "Add new feature"
   ```

4. **Push to the Branch**

   ```bash
   git push origin feature/YourFeature
   ```

5. **Open a Pull Request**


## License

This project is licensed under the MIT License. See the LICENSE file for details.

## Contact

For any inquiries or support, please email at [allison.lopatkin@rochester.edu](mailto:allison.lopatkin@rochester.edu).

---

**Disclaimer**: This repository contains customized scripts for plasmid count analysis. Ensure that you understand the parameters and their implications before usage. For any issues or bugs, please open an issue in the repository.
```








