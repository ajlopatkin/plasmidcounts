# Plasmid Count Analysis

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![Python Version](https://img.shields.io/badge/python-3.8+-blue.svg)

This repository serves as the supplementary code base for the research paper titled: **Plasmid prevalence is independent of antibiotic resistance in environmental Enterobacteriaceae**, authored by: **Danya Gewurz (dgewurz@gmail.com), Suhyeon Kim (skim328@ur.rochester.edu), Abhishek Sharma (ashar58@ur.rochester.edu), Joanna Harrison (joannacharrison@comcast.net), Ivan Lee (ilee24@u.rochester.edu), Nicole Rondeau (nicole.rondeau@nyulangone.org), JJ Miranda (jmiranda@barnard.edu), Brian Mailloux (bmailloux@barnard.edu), Kerry Hamilton (kerry.hamilton@asu.edu), Allison J. Lopaltin (allison.lopatkin@rochester.edu)**. The provided scripts and environment configurations allow users to replicate the plasmid count analysis performed in our study.

## Table of Contents

- [Project Overview](#project-overview)
- [Repository Structure](#repository-structure)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Usage](#usage)
  - [main.py](#mainpy)
  - [calibration_bootstrap.py](#calibration_bootstrappypy)
- [Outputs](#outputs)
- [Sensitivity Parameter Generation](#sensitivity-parameter-generation)
- [Contributing](#contributing)
- [License](#license)
- [Contact](#contact)

## Project Overview

This project This project processes genomic FASTA files to detect and quantify plasmids.The provided scripts automate the process of running PlasmidFinder, aggregating the results for downstream analysis, utilities for automated parameter sweeping and performance evaluation to optimize plasmid detection parameters.

## Repository Structure
├── plasmidCount_env.yml \
├── main.py \
├── plasmidcounts.py \
├── generate_sensitivity_data.py \
├── calibration_bootstraps.py \
├── Result \
├── README.md \
└── LICENSE 

- **plasmidCount_env.yml**: Conda environment file containing all dependencies required to run the scripts.
- **main.py**: The primary script to execute the plasmid count analysis.
- **plasmidcounts.py**: Core plasmid detection logic using PlasmidFinder and BLAST.
- **generate_sensitivity_data.py**:  Executes the analysis across various parameter sets to assess sensitivity.
- **calibration_bootstrap.py**: Evaluates and visualizes performance of parameter sets via bootstrapping.
- **Result**: Directory containing the output CSV and PDF files generated by the workflows.
- **README.md**: This documentation file.
- **LICENSE**: Licensing information for the repository.

## Prerequisites

- **Operating System**: Windows, macOS, or Linux
- **Python**: Version 3.8 or higher
- **Conda**: Anaconda or Miniconda installed
- **Dataset and Database**: [Example Data and PLSDB database](https://rochester.box.com/s/u7vzsq7ov03h4zt9d4nmq2lk117qvrgc)
  - `basedir/processed_data/ with two folders; processed_all_090323-flat_fasta/`: 238 short-read FASTA files
  - `long_read_genomes_only_assemblies_20221105/`: placeholder for long-read data
  - `db/` folder with plsdb.fna: the main plasmid reference database (required), plsdb.fna.nhr, plsdb.fna.nin, plsdb.fna.nsq: BLAST-formatted index files

## Installation

1. **Clone the Repository**

   ```bash
   git clone https://github.com/ajlopatkin/plasmidcounts
   cd plasmidcounts
   ```


2. **Create the Conda Environment**

   Ensure you have Conda installed. Then, create the environment using the provided YAML file:

   ```bash
   conda env create -f plasmidCount_env.yml
   ```

3. **Activate the Environment**

   ```bash
   conda activate plasmidCount_env
   ```

## Usage

### main.py

**Description**: Central interface for the entire plasmid analysis pipeline. Upon running, it prompts the user to choose between:

- running standard plasmid count analysis, or
- performing sensitivity analysis over multiple parameter settings.

**Note**: `main.py`, `plasmidcounts.py`, and `generate_sensitivity_data.py` must all be located in the same directory for the script to work properly.

**Workflow**

0. Prepare the example dataset and database.

1. After activating the environment, find the full paths to your Python interpreter and plasmidfinder.py script:
  
   ```bash
   which python
   which plasmidfinder.py
   ```
   Save these two paths-you will need to enter them when prompted the main.py
   
2. Run the main script:

   ```bash
   cd /path/to/folder/containing/main.py
   python main.py
   ```
   
4. Choose the analysis mode when prompted:
   
   ```bash
   Choose which analysis to run:
   1: Run plasmidcounts
   2: Run sensitivity analysis
   ```
   
5. If you choose 1, the script will prompt for:
   
   - `base_dir`: Path to the root folder containing all input data
   - `file_dir`: Comma-separated list of subfolders with FASTA files
   - `read_type`: Comma-separated list of read types for each subfolder (e.g.,short, long, scaffold)
   - `output_base`: Path to save results and intermediate files
   - `output_dir`: Specific directory to store this run’s output
   - `db_path`: Path to your local plasmid database (e.g., PLSdb)
   - `python_path`: Paste the path from which python
   - `plasmidfinder_path`: Paste the path from which plasmidfinder.py
   
   
   The script then executes plasmidcounts() using these inputs.

6. If you choose 2, the script will prompt for:

   - `base_dir`: Path to the root folder containing all input data
   - `file_dir`: Comma-separated list of subfolders with FASTA files
   - `read_type`: Comma-separated list of read types for each subfolder (e.g.,short, long, scaffold)
   - `output_base`: Path to save results and intermediate files
   - `db_path`: Path to your local plasmid database (e.g., PLSdb)
   - `python_path`: Paste the path from which python
   - `plasmidfinder_path`: Paste the path from which plasmidfinder.py

   The script will then execute a full parameter sweep using generate_sensitivity_data.py

### calibration_bootstrap.py

**Description**: Evaluates the results generated by generate_sensitivity_data.py to determine the most robust parameter set for plasmid count prediction. This script uses bootstrap sampling and a calibration/holdout split strategy to evaluate which parameter combinations consistently yield the most accurate predictions.

**Workflow**:

1. Make sure you have already run generate_sensitivity_data.py and collected results under a common root directory.
   
2. Prepare the true plasmid count CSV file with the following columns:
   
  - names_unique: unique genome ID (should match filenames)
  - shortread_genome_group: semicolon-separated plasmid groups, pipes separate plasmids within a group
    e.g., repA1|repA2;repB
  - shortread_genome_num: number of plasmids on the genome
  - contains_true_value: 1 to include the genome, 0 to skip

3. Run the script from the terminal:

   ```bash
   python calibration_bootstrap.py \
    --root_dir /path/to/sensitivity_outputs \
    --true_count_file true_counts.csv \
    --extension .fna \
    --match_cutoff 0.85 \
    --num_bootstrap 100
   ```

4. What happens next:

  - For each calibration size (number of strains), it runs multiple bootstrap iterations
  - In each iteration:
    - Chooses a subset of strains for calibration
    - Selects the best-matching condition (parameter set) for that subset
    - Tests its performance on the holdout strains
    - Also evaluates all parameter sets that exceed the match_cutoff
  - Computes accuracy statistics (mean, std, sem) per calibration size

## Outputs

**Description**: Depending on the selected mode, the following files will be generated in the specified output_dir or output_base

1. If you run standard plasmidcounts (Option 1):
   
  - `plasmidcount_aggregated.csv`: Summarizes plasmid counts per genome file.
  - `plasmidcount_results.csv`: Contains detailed information for each contig, including; filename, file_type, contig_name, plasmid_name, and blast_top_hit
  - `Plasmidfinder_results.csv`: PlasmidFinder output summarizing plasmid replicon hits across input files.

2. If you run senstivity analysis (Option 2):
   
  - A total of 100 folders (one per parameter set) will be created inside the specified output_base directory.
    Each folder is named as:
    
    ```bash
    iteration_0/, iteration_1/, ..., iteration_99/
    ```
  
  - Each folder contains:
    - `plasmidcount_results.csv`: full per-contig prediction results
    - `plasmidcount_aggregated.csv`: genome-level summary
    - `Plasmidfinder_results.csv`: replicon detection results
    - `params.txt`: the specific parameters used for that run (e.g., mash_cutoff, plasfinder_pid, etc.)
  
  - An additional folder called base_params/ is created using the default parameter set as a control.
  - These outputs can then be passed to calibration_bootstrap.py to identify the most accurate parameter combinations across genomes.

3. If you run calibration_bootstrap.py:

  - bootstrap_performance_plot.pdf: A line plot showing how average plasmid matching accuracy varies with calibration set size. Error bars represent SEM (standard error of the mean).
  - Terminal output: The script will also print the best-performing parameter set and its accuracy across all genomes. For example:
    
    ```bash
    Best match condition: iteration_42
    Matched plasmids: 91.3%
    ```
  - Optionally, a summary can be printed or saved containing: mean accuracy per calibration size, standard deviation and SEM, and parameter set used for each bootstrap iteration.
  - These calibration outputs help you identify the most robust parameter combination for future runs of plasmidcounts.py.
  
## Sensitivity Parameter Generation

**Description**: When sensitivity analysis is performed, the script samples a total of 100 random parameter sets (num_sets = 100) based on a range of values around each base parameter. This is used to explore how changes in thresholds affect plasmid classification accuracy.

1. Base Parameter Values

   - `contig_len_cutoff` = 500
   - `mash_cutoff` = 0.05
   - `plasfinder_cov` = 80
   - `plasfinder_pid` = 90
   - `read_threshold` = 5
   - `cover_threshold` = 1
   - `blast_id_cutoff` = 90
   - `blast_len_thresh` = 27000
   - `overlap_cutoff_short` = 0.01
   - `overlap_cutoff_long` = 0.15
   - `blast_len_cutoff` = 1000
   - `filter_col` = True
   - `filter_std` = True
   - `num_contig_thresh` = 3
   - `skip_interactive` = False

2. Sampling Strategy: Each parameter is varied within ±75% of its base value, bounded by logical minimum and maximum values.

   - `mash_cutoff`	= [0, 1]
   - `plasfinder_cov`	= [15, 100]
   - `plasfinder_pid` =	[65, 100]
   - `blast_id_cutoff`	= [70, 100]
   - `blast_len_thresh`	= [2500, 17500]
   - `overlap_cutoff_short`	= [0.0025, 0.0175]
   - `overlap_cutoff_long` =	[0.06, 0.42]

3. For each of the 100 iterations, one value is sampled at random from each parameter’s range to define a unique condition for testing.

4. Parameters Explained: All scripts require the user to specify several key parameters. Below is a detailed explanation of each:

- **`contig_len_cutoff`**: Minimum length for contigs to retain in the analysis.

- **`mash_cutoff`**: Mash distance threshold to consider two contigs as duplicates.

- **`plasfinder_cov`**: Coverage threshold for PlasmidFinder results.

- **`plasfinder_pid`**: Percent identity threshold for PlasmidFinder results.

- **`blast_len_thresh`**: Threshold for contig length to perform BLAST analysis.

- **`overlap_cutoff_short`**: Overlap cutoff for BLAST results in short contigs.

- **`overlap_cutoff_long`**: Overlap cutoff for BLAST results in long contigs.

- **`blast_len_cutoff`**: Cutoff for plasmid length in PLSdb BLAST analysis.

- **`filter_col`**: Flag to filter out Col plasmids.

- **`filter_std`**: Flag to filter high-variance strains based on standard deviations. Set to `0` to disable.

- **`num_contig_thresh`**: Minimum number of contigs required to apply high-variance strain filtering.
  

## Contributing

Contributions are welcome! Please follow these guidelines:

1. **Fork the Repository**

2. **Create a Feature Branch**

   ```bash
   git checkout -b feature/YourFeature
   ```

3. **Commit Your Changes**

   ```bash
   git commit -m "Add new feature"
   ```

4. **Push to the Branch**

   ```bash
   git push origin feature/YourFeature
   ```

5. **Open a Pull Request**


## License

This project is licensed under the MIT License. See the LICENSE file for details.

## Contact

For any inquiries or support, please email at [allison.lopatkin@rochester.edu](mailto:allison.lopatkin@rochester.edu).

---

**Disclaimer**: This repository contains customized scripts for plasmid count analysis. Ensure that you understand the parameters and their implications before usage. For any issues or bugs, please open an issue in the repository.
```








